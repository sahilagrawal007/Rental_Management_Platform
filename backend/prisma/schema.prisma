generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// User Types: CUSTOMER, VENDOR, ADMIN
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  companyName  String?  @map("company_name")
  gstin        String
  role         String   @default("CUSTOMER")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  products         Product[]
  quotations       Quotation[]
  ordersAsCustomer RentalOrder[] @relation("CustomerOrders")
  ordersAsVendor   RentalOrder[] @relation("VendorOrders")

  @@map("users")
}

// Products that can be rented
model Product {
  id             String   @id @default(uuid())
  vendorId       String   @map("vendor_id")
  name           String
  description    String?
  quantityOnHand Int      @map("quantity_on_hand")
  pricePerHour   Float?   @map("price_per_hour")
  pricePerDay    Float?   @map("price_per_day")
  pricePerWeek   Float?   @map("price_per_week")
  isPublished    Boolean  @default(false) @map("is_published")
  imageUrl       String?  @map("image_url")
  createdAt      DateTime @default(now()) @map("created_at")

  vendor               User                   @relation(fields: [vendorId], references: [id])
  quotationLines       QuotationLine[]
  orderLines           OrderLine[]
  inventoryReservations InventoryReservation[]

  @@map("products")
}

// Customer's cart/quote before confirming
model Quotation {
  id          String   @id @default(uuid())
  customerId  String   @map("customer_id")
  status      String   @default("DRAFT")
  totalAmount Float    @map("total_amount")
  createdAt   DateTime @default(now()) @map("created_at")

  customer       User            @relation(fields: [customerId], references: [id])
  quotationLines QuotationLine[]
  rentalOrder    RentalOrder?

  @@map("quotations")
}

// Items in a quotation
model QuotationLine {
  id          String   @id @default(uuid())
  quotationId String   @map("quotation_id")
  productId   String   @map("product_id")
  quantity    Int
  rentalStart DateTime @map("rental_start")
  rentalEnd   DateTime @map("rental_end")
  unitPrice   Float    @map("unit_price")
  subtotal    Float

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id])

  @@map("quotation_lines")
}

// Confirmed rental order
model RentalOrder {
  id              String   @id @default(uuid())
  quotationId     String   @unique @map("quotation_id")
  customerId      String   @map("customer_id")
  vendorId        String   @map("vendor_id")
  status          String   @default("CONFIRMED")
  totalAmount     Float    @map("total_amount")
  deliveryAddress String?  @map("delivery_address")
  createdAt       DateTime @default(now()) @map("created_at")

  quotation             Quotation              @relation(fields: [quotationId], references: [id])
  customer              User                   @relation("CustomerOrders", fields: [customerId], references: [id])
  vendor                User                   @relation("VendorOrders", fields: [vendorId], references: [id])
  orderLines            OrderLine[]
  invoice               Invoice?
  inventoryReservations InventoryReservation[]

  @@map("rental_orders")
}

// Items in an order
model OrderLine {
  id          String    @id @default(uuid())
  orderId     String    @map("order_id")
  productId   String    @map("product_id")
  quantity    Int
  rentalStart DateTime  @map("rental_start")
  rentalEnd   DateTime  @map("rental_end")
  unitPrice   Float     @map("unit_price")
  subtotal    Float
  isReturned  Boolean   @default(false) @map("is_returned")
  returnedAt  DateTime? @map("returned_at")

  order   RentalOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product     @relation(fields: [productId], references: [id])

  @@map("order_lines")
}

// Prevents double-booking
model InventoryReservation {
  id            String   @id @default(uuid())
  productId     String   @map("product_id")
  orderId       String   @map("order_id")
  quantity      Int
  reservedFrom  DateTime @map("reserved_from")
  reservedUntil DateTime @map("reserved_until")
  status        String   @default("RESERVED")
  createdAt     DateTime @default(now()) @map("created_at")

  product Product     @relation(fields: [productId], references: [id])
  order   RentalOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("inventory_reservations")
}

// Invoice for payment
model Invoice {
  id              String   @id @default(uuid())
  orderId         String   @unique @map("order_id")
  invoiceNumber   String   @unique @map("invoice_number")
  status          String   @default("DRAFT")
  subtotal        Float
  taxAmount       Float    @map("tax_amount")
  totalAmount     Float    @map("total_amount")
  amountPaid      Float    @default(0) @map("amount_paid")
  securityDeposit Float    @default(0) @map("security_deposit")
  lateFee         Float    @default(0) @map("late_fee")
  createdAt       DateTime @default(now()) @map("created_at")

  order    RentalOrder @relation(fields: [orderId], references: [id])
  payments Payment[]

  @@map("invoices")
}

// Payment records
model Payment {
  id            String   @id @default(uuid())
  invoiceId     String   @map("invoice_id")
  amount        Float
  paymentMethod String   @map("payment_method")
  transactionId String?  @map("transaction_id")
  status        String   @default("PENDING")
  paidAt        DateTime @default(now()) @map("paid_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}